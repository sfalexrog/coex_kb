# Подключение камеры px4flow

Модуль камеры [px4flow](https://docs.px4.io/en/sensor/px4flow.html) может использоваться автопилотами на базе прошивок [PX4](https://px4.io/) и [Ardupilot](http://ardupilot.org/). Подключение к автопилоту происходит с помощью интерфейса i2c, первоначальная настройка производится через USB. Прошивка модуля обновляется через [QGroundControl](http://qgroundcontrol.com/).

Некоторые соображения/наблюдения:

1. Камера использует различные прошивки для PX4 и Ardupilot. Соответственно, при первом подключении к QGroundControl следует выбрать и залить нужную прошивку.

1. Объектив камеры требует первоначальной настройки. При подключении камеры к QGroundControl в режиме ```Vehicle Setup``` появится вкладка просмотра изображения с камеры. Надо настроить объектив так, чтобы он фокусировался на объектах, удалённых на типичную высоту планируемого полёта (например, 1.5 метра).

1. Модули камеры часто продаются вместе с сонаром. Сонар этот, судя по [наблюдениям пользователей Ardupilot](http://ardupilot.org/copter/docs/common-px4flow-overview.html#overview), весьма ненадёжен; при этом [драйвер px4flow](https://github.com/PX4/Firmware/blob/73ed9deac507c86892afadee5bca2024b5b8da17/src/drivers/px4flow/px4flow.cpp#L553-L566) с радостью публикует данные с сонара в топик ```distance_sensor```, если [является основным дальномером](https://github.com/PX4/Firmware/blob/73ed9deac507c86892afadee5bca2024b5b8da17/src/drivers/px4flow/px4flow.cpp#L256-L266). Соответственно, если используется внешний дальномер, подключаемый по MAVLink'у, то указанный код лучше убрать (или хотя бы запускать драйвер с [недокументированным параметром R](https://github.com/PX4/Firmware/blob/73ed9deac507c86892afadee5bca2024b5b8da17/src/drivers/px4flow/px4flow.cpp#L685), указывающим направление сенсора, выставленным во что-то безобидное). Если этого не сделать, коптер будет периодически "подпрыгивать" в воздухе на пару десятков сантиметров.

1. (Это больше касается подключения внешних датчиков, подключенных через MAVLink, но, может, кому пригодится) При использовании EKF2 очень важно следить за тем, чтобы у сообщений был правильный timestamp. К сожалению, в прошивке 1.8.2 это не работает от слова "совсем", надо править приём сообщений в [mavlink_receiver.cpp](https://github.com/PX4/Firmware/blob/v1.8.2/src/modules/mavlink/mavlink_receiver.cpp#L828). Ещё для приёма сообщений ```OPTICAL_FLOW_RAD``` нужно заполнить в [структуре optical_flow_s](https://github.com/PX4/Firmware/blob/v1.8.2/src/modules/mavlink/mavlink_receiver.cpp#L680) поля ```max_flow_rate, min_ground_distance, max_ground_distance```, например, так, как это [сделано у Олега Калачева](https://github.com/okalachev/Firmware/commit/d87d6aa2ad6721eeb5e9544d7cfa3ff5c8e04512)

1. Для получения вменяемых результатов разработчики PX4 и px4flow **настоятельно** рекомендуют использовать **хорошую виброразвязку** как для автопилота, так и для камеры. Кроме того, камера [довольно неплохо создаёт электромагнитные помехи](https://github.com/PX4/Hardware/issues/8), так что её, возможно, стоит как-то экранировать (или хотя бы располагать подальше от GPS-приёмников).
