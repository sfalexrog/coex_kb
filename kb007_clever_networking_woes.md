# Боль и страдания от настройки сети на клевере

Данный документ представляет собой разрозненные записки сходящего с ума человека, пытающегося разобраться в сетях. Не удивляйтесь, если к концу слова перестанут складываться в предложения, а команды будут терять смысл - мало что может сравниться по бессмысленности и беспощадности, чем сети в Linux.

## Второй Wi-Fi адаптер

По умолчанию Клевер поднимает точку доступа на своём единственном адаптере, именуемом в системе как `wlan0`. За этот процесс отвечают несколько программ - в лучшем стиле использования Unix:

* `dhcpcd` - отвечает не только за получение IP-адреса на каждом из интерфейсов, но и за запуск на каждом интерфейсе `wpa_supplicant`'а. Каждому инстансу `wpa_supplicant` передаётся один и тот же конфиг;
* `wpa_supplicant` - отвечает за подключение к Wi-Fi сети или за создание таковой (это настраивается параметром `mode` в описании сети в `/etc/wpa_supplicant/wpa_supplicant.conf`);
* `dnsmasq` - выступает в роли dhcp-сервера на Raspberry.

`dhcpcd` будет запускать `wpa_supplicant` на всех беспроводных интерфейсах. На интерфейсе `wlan0` по умолчанию назначен статический ip-адрес (в файле `/etc/dhcpcd.conf`):

```conf
interface wlan0
static ip_address=192.168.11.1/24
```

Если подключить второй адаптер, на нём также запустится `wpa_supplicant`. Для того, чтобы этого не происходило, можно указать, на каких интерфейсах его не надо запускать:

```conf
denyinterfaces wlan1
```

Далее, `dnsmasq` будет работать только на некоторых интерфейсах. Можно поменять это в `/etc/dnsmasq.conf`:

```conf
...
interface=wlan0
address=/clever/coex/192.168.11.1
...
```

Если же надо запустить точку доступа на втором адаптере, надо сделать следующее:

* в `/etc/dhcpcd.conf` добавить/поменять:

    ```conf
    denyinterfaces wlan0
    interface wlan1
    static ip_address=192.168.11.1/24
    ````

* в `/etc/dnsmasq.conf` поменять:

    ```conf
    interface=wlan1
    ```

* помолиться и перезагрузиться.

Если боги были благосклонны, на внешнем адаптере поднимется нужная сеть. Если нет - надо проверять, может ли адаптер работать как точка доступа, проверить настройки сети в `wpa_supplicant.conf`, раскаяться во грехах и сходить в монастырь.

Наверняка есть более удобный способ поднятия сети, в идеале надо сделать коптер клиентом в одной из сетей и AP в другой.
